<!DOCTYPE html>
<html>
	<head>
		<title>My PWAs</title>
		<link rel="manifest" href="Manifest.json" />
		<style>
			#buttons {
				display: inline-flex;

				position: fixed;
				border: none;
				border-top: 1px solid green;
				bottom: 0px;
				left: 0px;
				right: 0px;

				height: 10%;
			}

			#allAppsButton {
				width: 50%;
				font-size: 40px;

				outline: none;
				border: none;
				background-color: white;
			}

			#installedAppsButton {
				width: 50%;
				font-size: 40px;

				outline: none;
				border: none;
				background-color: green;
				color: white;
			}

			#apps {
				text-align: center;
				width: 100%;
    			border-spacing: 80px;
			}

			button {
				cursor: pointer;
			}

			.installButton, .uninstallButton {
				width: 100px;
				height: 40px;
			}

			.loader {
				margin-left: 48%;
				margin-right: 52%;
				border: 5px solid #f3f3f3; /* Light grey */
				border-top: 5px solid #3498db; /* Blue */
				border-radius: 50%;
				width: 20px;
				height: 20px;
				animation: spin 2s linear infinite;
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
		</style>
	</head>

	<body>
		<table id="apps">
		</table>

		<footer id="buttons">
			<button id="allAppsButton">Toutes les applications</button>
			<button id="installedAppsButton">Installés</button>
		</footer>
	</body>
</html>

<script>
	var tab = 'installed';
	var pwas = [];

	const appsDiv = document.getElementById('apps');
	const allAppsButton = document.getElementById('allAppsButton');
	const installedAppsButton = document.getElementById('installedAppsButton');

	allAppsButton.addEventListener('click', function(e) {
		allAppsButton.style.backgroundColor = 'green';
		allAppsButton.style.color = 'white';
		installedAppsButton.style.backgroundColor = 'white';
		installedAppsButton.style.color = 'black';

		tab = 'all';
		refresh();
	});

	installedAppsButton.addEventListener('click', function(e) {
		installedAppsButton.style.backgroundColor = 'green';
		installedAppsButton.style.color = 'white';
		allAppsButton.style.backgroundColor = 'white';
		allAppsButton.style.color = 'black';

		tab = 'installed';
		refresh();
	});

	refresh();

	function install(i) {
		document.getElementById('div-' + i).children[4].outerHTML = '<div class="loader"></div>';

		fetch('/install', {
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			method: 'POST',
			body: JSON.stringify({repository: pwas[i].repository})
		}).then(function(response) {
			document.getElementById('div-' + i).children[4].outerHTML = `<button class="uninstallButton" onclick="uninstall('${i}')">Désinstaller</button>`;
		});
	}

	function uninstall(i) {
		document.getElementById('div-' + i).children[4].outerHTML = '<div class="loader"></div>';
		
		fetch('/uninstall', {
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			method: 'POST',
			body: JSON.stringify({pwa: pwas[i].name})
		}).then(function(response) {
			document.getElementById('div-' + i).children[4].outerHTML = `<button class="installButton" onclick="install('${i}')">Installer</button>`;
		});
	}

	function startApp(i) {
		window.location.href = '/' + pwas[i].name;
	}

	function showPwas() {
		var html = '<tr>';
		var i = 0;

		for (const pwa of pwas) {
			if (i % 2 == 0 && i != 0) {
				html += '</td></tr>';
			}

			if (tab == 'installed' && pwa.installed) {
				html += `<td><div id="div-${i}">`;
				html += `<img src="${pwa.favicon}" onclick="startApp('${i}')" width="200" height="200" style="cursor: pointer" /><br>`;
				html += `<label style="font-size: 40px; font-family: sans-serif;cursor: pointer" onclick="startApp('${i}')">${pwa.title}</label><br>`;
			} else if (tab == 'all') {
				html += `<td><div id="div-${i}">`;
				html += `<img src="${pwa.favicon}" width="200" height="200" /><br>`;
				html += `<label style="font-size: 40px; font-family: sans-serif;">${pwa.title}</label><br>`;

				if (pwa.installed) {
					html += `<button class="uninstallButton" onclick="uninstall('${i}')">Désinstaller</button>`;
				} else {
					html += `<button class="installButton" onclick="install('${i}')">Installer</button>`;
				}
			}

			i++;
			html += '</div></td>';
		}

		html += '</tr>';
		
		appsDiv.innerHTML = html;
	}

	function refresh() {
		fetch('/allPwas').then(function(response) {
			response.json().then(function(json) {
				pwas = json.response;
				showPwas();
			});
		});
	}

	if('serviceWorker' in navigator) {
		navigator.serviceWorker.register('./sw.js');
	};
</script>