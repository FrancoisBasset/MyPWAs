<!DOCTYPE html>
<html>
	<head>
		<title>My PWAs</title>
		<style>
			#buttons {
				display: inline-flex;

				position: fixed;
				border: 1px solid black;
				bottom: 0px;
				left: 0px;
				right: 0px;

				height: 10%;
			}

			#allAppsButton {
				width: 50%;
				cursor: pointer;
				font-size: 40px;

				outline: none;
				border: 1px solid black;
				background-color: white;
			}

			#installedAppsButton {
				width: 50%;
				cursor: pointer;
				font-size: 40px;

				outline: none;
				border: 10px solid green;
				background-color: white;
			}
		</style>
	</head>

	<body>
		<div id="apps">

		</div>

		<footer id="buttons">
			<button id="allAppsButton">Toutes les applications</button>
			<button id="installedAppsButton">Installés</button>
		</footer>
	</body>
</html>

<script>
	var tab = 'installed';
	var pwas = [];

	const appsDiv = document.getElementById('apps');
	const allAppsButton = document.getElementById('allAppsButton');
	const installedAppsButton = document.getElementById('installedAppsButton');

	allAppsButton.addEventListener('click', function(e) {
		allAppsButton.style.border = '10px solid green';
		installedAppsButton.style.border = '1px solid black';

		tab = 'all';
		refresh();
	});

	installedAppsButton.addEventListener('click', function(e) {
		installedAppsButton.style.border = '10px solid green';
		allAppsButton.style.border = '1px solid black';

		tab = 'installed';
		refresh();
	});

	refresh();

	function install(repository) {
		fetch('/install', {
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			method: 'POST',
			body: JSON.stringify({repository: repository})
		}).then(function(response) {
			response.json().then(function(json) {
				pwas = json.response;
				showPwas();
			});
		});
	}

	function uninstall(pwa) {
		fetch('/uninstall', {
			headers: {
				'Accept': 'application/json',
				'Content-Type': 'application/json'
			},
			method: 'POST',
			body: JSON.stringify({pwa: pwa})
		}).then(function(response) {
			response.json().then(function(json) {
				pwas = json.response;
				showPwas();
			});
		});
	}

	function startApp(name) {
		window.location.href = '/' + name;
	}

	function showPwas() {
		appsDiv.innerHTML = '';

		for (const pwa of pwas) {
			appsDiv.innerHTML += `<div>`;

			if (tab == 'installed') {
				if (pwa.installed) {
					appsDiv.innerHTML += `<img src="${pwa.favicon}" width="200" height="200" />`;
					appsDiv.innerHTML += `<label>${pwa.title}</label>`;
					appsDiv.innerHTML += `<button onclick="startApp('${pwa.name}')">Lancer</label>`;
				}
			} else if (tab == 'all') {
				if (pwa.installed) {
					appsDiv.innerHTML += `<img src="${pwa.favicon}" width="200" height="200" />`;
					appsDiv.innerHTML += `<label>${pwa.title}</label>`;
					appsDiv.innerHTML += `<button onclick="uninstall('${pwa.name}')">Désinstaller</label>`;
				} else {
					appsDiv.innerHTML += `<img src="${pwa.favicon}" width="200" height="200" />`;
					appsDiv.innerHTML += `<label>${pwa.title}</label>`;
					appsDiv.innerHTML += `<button onclick="install('${pwa.repository}')">Installer</label>`;
				}
			}
			
			appsDiv.innerHTML += '</div>';
		}
	}

	function refresh() {
		fetch('/allPwas').then(function(response) {
			response.json().then(function(json) {
				pwas = json.response;
				showPwas();
			});
		});
	}
</script>